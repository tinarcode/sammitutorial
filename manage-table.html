<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™è¡¨ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 { color: #333; }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #2196F3;
            text-decoration: none;
        }
        .back-link:hover { text-decoration: underline; }
        
        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }
        .btn-primary { background-color: #4CAF50; color: white; }
        .btn-primary:hover { background-color: #45a049; }
        .btn-secondary { background-color: #2196F3; color: white; }
        .btn-secondary:hover { background-color: #0b7dda; }
        .btn-danger { background-color: #f44336; color: white; }
        .btn-danger:hover { background-color: #da190b; }
        .btn-warning { background-color: #ff9800; color: white; }
        .btn-warning:hover { background-color: #e68900; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        
        /* è¨Šæ¯æ¨£å¼ */
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">â† è¿”å›é¦–é </a>
    
    <div class="container">
        <h1>è³‡æ–™è¡¨ç®¡ç†</h1>
        
        <div class="form-group">
            <label>é¸æ“‡è¡¨ï¼š</label>
            <select id="tableSelect" onchange="loadTableData()">
                <option value="">-- è«‹é¸æ“‡è¡¨ --</option>
            </select>
            <button onclick="loadTables()" class="btn-secondary">é‡æ–°è¼‰å…¥è¡¨åˆ—è¡¨</button>
        </div>
        
        <button onclick="showAddModal()" class="btn-primary">â• æ–°å¢æ•¸æ“š</button>
        <button onclick="loadTableData()" class="btn-secondary">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        
        <div id="message"></div>
        
        <div id="tableContainer"></div>
    </div>
    
    <!-- æ–°å¢/ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">æ–°å¢æ•¸æ“š</h2>
            <div id="formFields"></div>
            <button onclick="saveData()" class="btn-primary">å„²å­˜</button>
            <button onclick="closeModal()" class="btn-secondary">å–æ¶ˆ</button>
        </div>
    </div>
    
    <script src="api-config.js"></script>
    <script>
        let currentTable = '';
        let currentData = [];
        let editingId = null;
        
        // è¼‰å…¥æ‰€æœ‰è¡¨
        async function loadTables() {
            try {
                const data = await DatabaseAPI.query('SHOW TABLES');
                const select = document.getElementById('tableSelect');
                select.innerHTML = '<option value="">-- è«‹é¸æ“‡è¡¨ --</option>';
                
                if (data.status === 'success' && data.data) {
                    data.data.forEach(row => {
                        const tableName = Object.values(row)[0];
                        const option = document.createElement('option');
                        option.value = tableName;
                        option.textContent = tableName;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showMessage('è¼‰å…¥è¡¨åˆ—è¡¨å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥è¡¨æ•¸æ“š
        async function loadTableData() {
            currentTable = document.getElementById('tableSelect').value;
            
            if (!currentTable) {
                document.getElementById('tableContainer').innerHTML = '';
                return;
            }
            
            try {
                const data = await DatabaseAPI.query(`SELECT * FROM \`${currentTable}\``);
                
                if (data.status === 'success' && data.data) {
                    currentData = data.data;
                    displayTable(data.data);
                    showMessage(`æˆåŠŸè¼‰å…¥ ${data.count} ç­†æ•¸æ“š`, 'success');
                } else {
                    showMessage(data.message || 'è¼‰å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // é¡¯ç¤ºè¡¨æ ¼
        function displayTable(data) {
            const container = document.getElementById('tableContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p>æ²’æœ‰æ•¸æ“š</p>';
                return;
            }
            
            const columns = Object.keys(data[0]);
            
            let html = '<table><thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '<th>æ“ä½œ</th></tr></thead><tbody>';
            
            data.forEach((row, index) => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] !== null ? row[col] : '<em>NULL</em>'}</td>`;
                });
                html += `<td>
                    <button onclick="showEditModal(${index})" class="btn-warning">âœï¸ ç·¨è¼¯</button>
                    <button onclick="deleteRow(${index})" class="btn-danger">ğŸ—‘ï¸ åˆªé™¤</button>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // é¡¯ç¤ºæ–°å¢æ¨¡æ…‹æ¡†
        async function showAddModal() {
            if (!currentTable) {
                showMessage('è«‹å…ˆé¸æ“‡è¡¨', 'error');
                return;
            }
            
            editingId = null;
            document.getElementById('modalTitle').textContent = 'æ–°å¢æ•¸æ“š';
            
            try {
                // ç›´æ¥æŸ¥è©¢è¡¨çµæ§‹
                const data = await DatabaseAPI.query(`DESCRIBE \`${currentTable}\``);
                
                if (data.status === 'success' && data.data) {
                    const columns = data.data.map(col => col.Field);
                    generateForm(columns, {});
                    document.getElementById('editModal').style.display = 'block';
                } else {
                    showMessage('ç„¡æ³•å–å¾—è¡¨çµæ§‹', 'error');
                }
            } catch (error) {
                showMessage('å–å¾—è¡¨çµæ§‹å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // é¡¯ç¤ºç·¨è¼¯æ¨¡æ…‹æ¡†
        function showEditModal(index) {
            editingId = index;
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯æ•¸æ“š';
            
            const row = currentData[index];
            const columns = Object.keys(row);
            generateForm(columns, row);
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // ç”Ÿæˆè¡¨å–®
        function generateForm(columns, data) {
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';
            
            columns.forEach(col => {
                const div = document.createElement('div');
                div.className = 'form-group';
                
                const label = document.createElement('label');
                label.textContent = col;
                div.appendChild(label);
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `field_${col}`;
                input.value = data[col] !== undefined && data[col] !== null ? data[col] : '';
                
                // ID å’Œæ™‚é–“æˆ³æ¬„ä½è¨­ç‚ºåªè®€ï¼ˆç·¨è¼¯æ™‚ï¼‰ï¼Œæ–°å¢æ™‚éš±è—
                const isAutoField = col.toLowerCase() === 'id' || 
                                   col.toLowerCase().includes('_at') ||
                                   col.toLowerCase().includes('timestamp');
                
                if (isAutoField) {
                    if (editingId !== null) {
                        // ç·¨è¼¯æ¨¡å¼ï¼šè¨­ç‚ºåªè®€
                        input.readOnly = true;
                        input.style.backgroundColor = '#f0f0f0';
                    } else {
                        // æ–°å¢æ¨¡å¼ï¼šéš±è—è‡ªå‹•æ¬„ä½
                        if (col.toLowerCase() === 'id') {
                            div.style.display = 'none';
                        }
                    }
                }
                
                div.appendChild(input);
                formFields.appendChild(div);
            });
        }
        
        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // å„²å­˜æ•¸æ“š
        async function saveData() {
            if (!currentTable) return;
            
            const formData = {};
            const inputs = document.getElementById('formFields').querySelectorAll('input');
            
            inputs.forEach(input => {
                const fieldName = input.id.replace('field_', '');
                // æ–°å¢æ™‚ä¸åŒ…å« id æ¬„ä½ï¼Œæ›´æ–°æ™‚ä¸åŒ…å«åªè®€æ¬„ä½
                if (editingId === null) {
                    // æ–°å¢ï¼šæ’é™¤ id å’Œå…¶ä»–åªè®€æ¬„ä½
                    if (!input.readOnly && input.value.trim() !== '') {
                        formData[fieldName] = input.value;
                    }
                } else {
                    // æ›´æ–°ï¼šåªæ’é™¤åªè®€æ¬„ä½
                    if (!input.readOnly) {
                        formData[fieldName] = input.value;
                    }
                }
            });
            
            try {
                let result;
                
                if (editingId === null) {
                    // æ–°å¢
                    result = await fetch(API_CONFIG.baseURL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'insert',
                            table: currentTable,
                            data: formData
                        })
                    });
                } else {
                    // æ›´æ–°
                    const row = currentData[editingId];
                    const idField = Object.keys(row)[0]; // å‡è¨­ç¬¬ä¸€å€‹æ¬„ä½æ˜¯ ID
                    
                    result = await fetch(API_CONFIG.baseURL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'update',
                            table: currentTable,
                            data: formData,
                            where: { [idField]: row[idField] }
                        })
                    });
                }
                
                const data = await result.json();
                
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    closeModal();
                    loadTableData();
                } else {
                    showMessage(data.message || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('æ“ä½œå¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // åˆªé™¤æ•¸æ“š
        async function deleteRow(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ•¸æ“šå—ï¼Ÿ')) return;
            
            const row = currentData[index];
            const idField = Object.keys(row)[0]; // å‡è¨­ç¬¬ä¸€å€‹æ¬„ä½æ˜¯ ID
            
            try {
                const result = await fetch(API_CONFIG.baseURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        table: currentTable,
                        where: { [idField]: row[idField] }
                    })
                });
                
                const data = await result.json();
                
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    loadTableData();
                } else {
                    showMessage(data.message || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(msg, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = msg;
            
            setTimeout(() => {
                messageDiv.className = '';
                messageDiv.textContent = '';
            }, 3000);
        }
        
        // é é¢è¼‰å…¥æ™‚è¼‰å…¥è¡¨åˆ—è¡¨
        window.onload = function() {
            loadTables();
        };
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
